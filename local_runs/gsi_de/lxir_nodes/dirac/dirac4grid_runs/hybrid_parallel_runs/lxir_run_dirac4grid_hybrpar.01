#!/bin/bash

#
# script for interactive job runs on Valeria private GSI nodes
#
#  lxir022-lxir026
#  lxir071-lxir074
#
# Launched as:
# ~~~~~~~~~~~~
# nohup lxir_run_gsi.01 &> log.lxir_run_gsi.01.std_err_out &
#

echo -e "\nRunning on host `hostname -f`"
echo Time is `date`
echo Directory is `pwd`

NPROCS=`cat /proc/cpuinfo | grep processor | wc -l`
echo -e "\nThis node has $NPROCS CPUs."

echo -e "\nWorking server memory status"
free -m -t -h

echo -e "\n Loaded Modules"
module list

#DIRAC=/u/milias/Work/qch/software/dirac/trunk
DIRAC=/u/milias/Work/qch/software/dirac/dirac_for_grid

BUILD1=$DIRAC/build_gnumkl_i8_static
PAM1=$BUILD1/pam
BUILD2=$DIRAC/build_intelmkl_i8_static/
PAM2=$BUILD2/pam

BUILD_MPI1=$DIRAC/build_intelmkl_openmpi-1.10.1_i8_static
PAM_MPI1=$BUILD_MPI1/pam
BUILD_MPI2=$DIRAC/build_openmpi_gnu_i8_openblas_static

# secure for running test
export DIRTIMEOUT="12m"

# basis directory environmental variable
export BASDIR="$DIRAC/basis:$DIRAC/basis_dalton:$DIRAC/basis_ecp"

#
# Mixed parallel OpenMPI/OpenMP run on 1 node (8cpus)
#
# Main cycle over np(#cpu), MKL number of threads
#
for ij in 1-1 1-2 1-4 1-8 2-1 2-2 2-4 4-1 4-2; do

  set -- ${ij//-/ }
  np=$1
  nmkl=$2

  # we have unique string of time !
  timestamp1=`date +\%F_\%k-\%M-\%S`; timestamp=${timestamp1// /};
  echo -e "\n\n Running DIRAC at "$timestamp ; echo -e "\n\n"
  export TSTDIR=DIRACtestdir.$ij.$timestamp
  export DIRAC_TMPDIR="/data.local/milias/TEST.$TSTDIR"

  unset PATH_SAVED
  export PATH_SAVED=$PATH
  export PATH=$BUILD_MPI1:$PATH
  unset OPAL_PREFIX
  export OPAL_PREFIX=$BUILD_MPI1

  export MKL_NUM_THREADS=$nmkl
  #echo "Internal MKL library parallelization with MKL_NUM_THREADS=$MKL_NUM_THREADS"
  export OMP_NUM_THREADS=1
  export MKL_DYNAMIC="FALSE"
  export OMP_DYNAMIC="FALSE"

  export DIRAC_MPI_COMMAND="mpirun -np ${np}"

  echo -e "\n OpenMPI hybrid-parallel run, OpenMP:MKL_NUM_THREADS=${MKL_NUM_THREADS}; OpenMPI:DIRAC_MPI_COMMAND=${DIRAC_MPI_COMMAND}; disk space:DIRAC_TMPDIR=${DIRAC_TMPDIR} :"
  echo -e "OpenMPI which mpirun ? \c"; which mpirun

  #$PAM_MPI1 --noarch --mol=$DIRAC/test/cosci_energy/F.mol --inp=$DIRAC/test/cosci_energy/ci.inp
  time $DIRAC/test/cc_linear/test -b $BUILD_MPI1 -w $DIRAC_TMPDIR 
  #remove scratch space aftrwards
  /bin/rm -r $DIRAC_TMPDIR

done # end cycle over OpenMPI-OpenMP number of threads


exit 0
